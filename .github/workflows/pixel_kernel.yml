name: Build Pixel 6 Kernel 6.6

on:
  workflow_dispatch: # 手动触发

jobs:
  build_kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 400

    steps:
      - name: 1. 释放磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: 2. 环境依赖准备
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev git-lfs repo
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: 3. 安装 Repo 工具
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

- name: 4. 同步内核源码 (6.6 分支)
        run: |
          mkdir kernel-workspace && cd kernel-workspace
          # 使用更通用的 6.6 分支，确保能找到远程引用
          repo init -u https://android.googlesource.com/kernel/manifest -b gs-android15-6.6 --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      - name: 5. 验证项目结构
        working-directory: ./kernel-workspace
        run: |
          echo "检查驱动目录..."
          if [ -d "private/devices/google/raviole" ]; then
            echo "✅ 找到 Pixel 6 (raviole) 驱动"
          else
            echo "❌ 未找到驱动，正在搜索正确路径..."
            find . -maxdepth 4 -name "slider_dist"
          fi

      - name: 6. 使用 Kleaf (Bazel) 编译
        working-directory: ./kernel-workspace
        run: |
          # 针对 Pixel 6 (slider) 的 6.6 内核编译命令
          # 修正了内存限制语法以适配新版 Bazel
          ./tools/bazel run --local_resources=memory=HOST_RAM*.7,cpu=HOST_CPUS //private/devices/google/raviole:slider_dist -- --dist_dir=out/dist

      - name: 7. 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-Kernel-6.6-Artifacts
          path: |
            kernel-workspace/out/dist/boot.img
            kernel-workspace/out/dist/dtbo.img
            kernel-workspace/out/dist/vendor_boot.img
            kernel-workspace/out/dist/vendor_kernel_boot.img
            kernel-workspace/out/dist/initramfs.img
