name: Pixel 6 Kernel Build (Ultimate Space Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: 1. 深度扩容磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: 2. 安装依赖工具
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev git-lfs python3 curl
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: 3. Repo 初始化与同步 (深度优化)
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "KernelBot"
          mkdir kernel && cd kernel
          # 使用 --depth=1 极度压缩 Git 历史
          repo init -u https://android.googlesource.com/kernel/manifest -b gs-android-gs-raviole-mainline --depth=1
          repo sync -j$(nproc) -c --no-tags --no-clone-bundle

      - name: 4. 极限手术：删除无关平台工具 (腾出约 15GB)
        run: |
          cd kernel
          # 删除所有不属于 linux-x86 的预编译工具（如 MacOS/Windows 平台）
          find prebuilts -type d \( -name "darwin-x86" -o -name "windows-x86" -o -name "darwin-arm64" \) -exec rm -rf {} + || true
          # 删除不需要的 clang 说明文档和测试
          find prebuilts -type d -name "test" -path "*clang*" -exec rm -rf {} + || true
          df -h

      - name: 5. 执行编译 (禁用巨型归档)
        run: |
          cd kernel
          # 建立必要的软链接
          ln -sfn private/google-modules gs
          
          # 核心修复：
          # --no-archive: 禁止生成数 GB 的 unstripped_modules.tar.gz（你报错的根源）
          # --jobs=2: 稳定压制，防止瞬时磁盘写爆
          ./tools/bazel run --config=fast \
            --jobs=2 \
            --strategy=KernelModule=standalone \
            --strategy=GenRule=standalone \
            //private/google-modules/soc/gs:slider_dist -- \
            --destdir out/dist \
            --no-archive

      - name: 6. 归档产物
        if: success()
        run: |
          cd kernel/out/dist/
          ls -lh
          # 只打包核心镜像，进一步节省上传时间
          tar -czvf ${{ github.workspace }}/pixel6-slider-kernel.tar.gz boot.img *dtb* *.img || tar -czvf ${{ github.workspace }}/pixel6-slider-kernel.tar.gz .

      - name: 7. 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-Slider-Final
          path: pixel6-slider-kernel.tar.gz
          retention-days: 3
