name: Build Kernel 6.12 (Direct Git)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 释放磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"

      - name: 2. 安装环境
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev git-lfs python3
          # 编译 6.12 需要最新的交叉编译器
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: 3. 直接克隆 6.12 源码
        run: |
          # 直接拉取你指定的那个 Tag，深度 1 节省空间
          git clone --branch android-mainline-6.12 https://android.googlesource.com/kernel/common --depth=1 kernel-612

      - name: 4. 传统方式编译 (非 Bazel)
        working-directory: ./kernel-612
        run: |
          # 由于没有 repo 就没有 Kleaf 环境，我们回归传统的内核编译方式
          # 这种方式最稳，不依赖 Google 复杂的 Bazel 规则
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          
          # 1. 配置内核
          make defconfig
          
          # 2. 编译内核镜像 (使用所有 CPU 核心)
          make -j$(nproc) Image
          
          echo "编译完成，检查产物..."
          ls -l arch/arm64/boot/Image

      - name: 5. 上传内核镜像
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-6.12-Image
          path: kernel-612/arch/arm64/boot/Image
