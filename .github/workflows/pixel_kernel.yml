name: Build Pixel 6 Mainline 6.12 GKI

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 释放磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"

      - name: 2. 环境准备
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev git-lfs repo
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: 3. 安装 Repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: 4. 同步主线源码并切换到 6.12 Tag
        run: |
          mkdir kernel-workspace && cd kernel-workspace
          # 使用 android-mainline 清单，这是获取 6.12 最正确的路径
          repo init -u https://android.googlesource.com/kernel/manifest -b android-mainline --depth=1
          repo sync -c -j8
          
          # 进入 common 目录切换到你要求的 6.12 标签
          cd common
          git fetch --tags
          git checkout android-mainline-6.12
          cd ..

      - name: 5. 编译 GKI 6.12 核心
        working-directory: ./kernel-workspace
        run: |
          # 自动寻找 bazel 路径，防止不同分支路径不一
          BAZEL_BIN=$(find . -name "bazel" -type f -executable | head -n 1)
          echo "使用 Bazel 路径: $BAZEL_BIN"
          
          # 运行编译：这次使用最稳的 aarch64 目标
          $BAZEL_BIN run --jobs=2 //common:kernel_aarch64_dist -- --dist_dir=out/dist

      - name: 6. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-GKI-6.12-Kernel
          path: kernel-workspace/out/dist/boot.img
