name: Build Pixel 6 Mainline Kernel 6.12

on:
  workflow_dispatch: # 允许手动点击按钮触发编译

jobs:
  build_kernel:
    runs-on: ubuntu-latest
    # 编译内核非常耗时，设置 6 小时超时限制
    timeout-minutes: 360

    steps:
      - name: 1. 腾出磁盘空间
        run: |
          echo "正在清理环境以释放磁盘空间..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: 2. 安装必要依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev git-lfs repo
          # 确保 git 配置正确
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: 3. 安装并配置 Repo 工具
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          # 将 ~/bin 添加到全局 PATH，确保后续步骤都能直接使用 repo 命令
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: 4. 同步内核源码 (gs-android16-6.12-gs101)
        run: |
          # 必须先创建工作目录
          mkdir kernel-workspace && cd kernel-workspace
          repo init -u https://android.googlesource.com/kernel/manifest -b gs-android16-6.12-gs101 --depth=1
          # 同步可能需要 20-40 分钟
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          echo "WORKSPACE_PATH=$(pwd)" >> $GITHUB_ENV

      - name: 5. 验证项目结构
        working-directory: ./kernel-workspace
        run: |
          ls -F
          # 检查编译 6.12 所需的关键目录
          if [ -d "private/devices/google/raviole" ]; then
            echo "✅ 找到 Pixel 6 (raviole) 专用驱动目录"
          else
            echo "❌ 警告: 未在 private 目录找到驱动，搜索实际位置:"
            find . -maxdepth 4 -name "slider_dist"
          fi

      - name: 6. 使用 Kleaf 专用脚本编译内核
        working-directory: ./kernel-workspace
        run: |
          # 1. 尝试使用官方推荐的入口脚本，它会自动处理复杂的 Bazel 依赖
          # Pixel 6 的编译代号在 Android 14/15/16 统一为 slider
          
          # 先赋予执行权限
          chmod +x build/kernel/kleaf/bazel.sh || true
          
          # 2. 执行编译命令
          # 我们不再手动传递复杂的内存参数，让 Kleaf 自动管理
          # 如果你的分支里没有 build_slider.sh，我们直接调用 bazel
          
          if [ -f "build_slider.sh" ]; then
            echo "✅ 找到 build_slider.sh，启动专用脚本编译..."
            ./build_slider.sh
          else
            echo "⚠️ 未找到 build_slider.sh，使用底层的 bazel 编译..."
            # 修正后的内存参数语法
            ./tools/bazel run --local_resources=memory=HOST_RAM*.8,cpu=HOST_CPUS //common:kernel_aarch64_dist -- --dist_dir=out/dist
          fi

      - name: 7. 上传编译镜像 (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-Mainline-6.12-Images
          path: |
            kernel-workspace/out/dist/boot.img
            kernel-workspace/out/dist/dtbo.img
            kernel-workspace/out/dist/vendor_boot.img
            kernel-workspace/out/dist/initramfs.img
            kernel-workspace/out/dist/vendor_kernel_boot.img
          if-no-files-found: warn
