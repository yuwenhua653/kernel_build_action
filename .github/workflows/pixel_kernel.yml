name: Pixel 6 Kernel Build (Slider Fast)

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    # 设置较长的超时时间，内核编译通常需要 2-3 小时
    timeout-minutes: 360 

    steps:
      - name: 1. 深度扩容磁盘空间
        uses: jlumbroso/free-disk-space@main
        with:
          # 核心：删除不需要的预装环境，腾出约 100GB+ 空间
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: 2. 检查可用空间
        run: |
          echo "清理后的磁盘状态："
          df -h

      - name: 3. 安装依赖工具
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev git-lfs python3 curl
          # 安装 Google Repo 工具
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: 4. Repo 初始化与同步 (深度优化)
        run: |
          git config --global user.email "bot@example.com"
          git config --global user.name "KernelBot"
          mkdir kernel && cd kernel
          
          # 必须使用 --depth=1 减少 Git 历史记录占用的空间
          repo init -u https://android.googlesource.com/kernel/manifest -b gs-android16-6.12-gs101 --depth=1
          
          # 仅同步当前分支，避免拉取不相关的设备驱动
          repo sync -j$(nproc) -c --no-tags --no-clone-bundle
          
          # 修复可能缺失的软链接
          ln -sfn private/google-modules gs
          echo "同步后的磁盘状态："
          df -h
          
      - name: 5. 极限删除无关平台预建工具
        run: |
          cd kernel
          # 删除所有不属于 linux-x86 的工具链（如 darwin/windows 平台）
          find prebuilts -type d -name "darwin-x86" -exec rm -rf {} + || true
          find prebuilts -type d -name "windows-x86" -exec rm -rf {} + || true
          # 删除不需要的测试或文档目录
          rm -rf prebuilts/clang-tools/*-darwin
          df -h

      - name: 6. 执行最终修正的编译命令
        run: |
          cd kernel
          # 注意：slider_dist 使用 --destdir 参数而不是 --dist_dir
          ./tools/bazel run --config=fast \
            --jobs=2 \
            --strategy=KernelModule=standalone \
            --strategy=GenRule=standalone \
            //private/google-modules/soc/gs:slider_dist -- --destdir out/dist

      - name: 7. 归档产物 (路径修正版)
        if: always() # 即使之前有警告也执行，确保我们能看到文件在哪
        run: |
          # 进入包含镜像的实际目录
          cd kernel/out/dist/
          ls -R # 在日志里列出所有文件，确保 boot.img 在这里
          # 打包当前目录下所有文件，存放到上级目录的物理路径
          tar -czvf ../../../pixel6-slider-kernel.tar.gz .
          
      - name: 8. 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-Slider-Artifacts
          # 这里的路径必须与上面 tar 命令生成的位置完全一致
          path: pixel6-slider-kernel.tar.gz
