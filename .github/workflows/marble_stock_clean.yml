name: Build Marble Pure Kernel (Toolchain Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境准备
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm git-lfs python3 curl zip wget

      - name: 2. 获取内核源码与稳健工具链
        run: |
          # 1. 克隆 marble 内核源码
          git clone --depth=1 https://github.com/Pzqqt/android_kernel_xiaomi_marble -b melt-rebase kernel
          
          # 2. 获取 ZyC Clang (这是目前最稳、最适配的方案)
          mkdir clang
          cd clang
          # 使用 ZyC 的稳定版 Clang 17
          wget https://github.com/ZyCromerZ/Clang/releases/download/17.0.0-20230522-release/Clang-17.0.0-20230522-release.tar.gz
          tar -xf Clang-17.0.0-20230522-release.tar.gz
          cd ..
          
          # 3. 获取辅助 GCC (Marble 5.10 编译必备)
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 -b lineage-19.1 gcc64
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 -b lineage-19.1 gcc32

      - name: 3. 执行编译 (全参数适配版)
        run: |
          cd kernel
          # 设置路径：ZyC Clang 的可执行文件在 bin 下
          CLANG_PATH=$GITHUB_WORKSPACE/clang/bin
          GCC64_PATH=$GITHUB_WORKSPACE/gcc64/bin
          GCC32_PATH=$GITHUB_WORKSPACE/gcc32/bin
          export PATH=$CLANG_PATH:$GCC64_PATH:$GCC32_PATH:$PATH
          
          OUT_DIR=out
          # 自动寻找配置文件
          CONF_FILE=$(find arch/arm64/configs/ -name "marble_defconfig" | sed 's|arch/arm64/configs/||')
          echo "Using Config: $CONF_FILE"

          # 配置内核
          make -j$(nproc) O=$OUT_DIR ARCH=arm64 \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            $CONF_FILE
          
          # 开始全面编译
          # 注意：ZyC Clang 建议使用 LLVM=1 参数来简化路径
          make -j$(nproc) O=$OUT_DIR ARCH=arm64 \
            CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            LLVM=1 LLVM_IAS=1 \
            LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: 4. 打包 AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
          sed -i 's/block=\/dev\/block\/platform\/omap\/omap_hsmmc.1\/by-name\/boot/block=auto/g' AnyKernel3/anykernel.sh
          
          # 寻找并提取 Image.gz 和 dtbo.img
          find kernel/out/arch/arm64/boot/ -name "Image.gz*" -exec cp {} AnyKernel3/Image.gz \;
          find kernel/out/arch/arm64/boot/ -name "dtbo.img" -exec cp {} AnyKernel3/ \;
          
          cd AnyKernel3
          zip -r ../marble-melt-kernel.zip ./*

      - name: 5. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: Marble-Melt-Rebase-Kernel
          path: marble-melt-kernel.zip
