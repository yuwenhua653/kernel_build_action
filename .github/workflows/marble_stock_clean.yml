name: Build Marble Pure Kernel (Space Optimized)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 深度清理磁盘空间 (保命步骤)
        run: |
          sudo docker image prune -a -f
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf /etc/apt/sources.list.d/*
          df -h # 查看清理后的空间

      - name: 2. 安装环境依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3 curl zip wget

      - name: 3. 获取内核源码与工具链 (极致精简克隆)
        run: |
          # 仅克隆最近一次提交，减少磁盘占用
          git clone --depth=1 https://github.com/Pzqqt/android_kernel_xiaomi_marble -b melt-rebase kernel
          
          # 获取 Clang (只克隆主分支最新版，不拉历史)
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 -b main clang_dir
          
          # 获取 GCC (同样 depth=1)
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 -b lineage-19.1 gcc64
          git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 -b lineage-19.1 gcc32

      - name: 4. 执行编译
        run: |
          cd kernel
          # 动态寻找 Clang 路径
          CLANG_BIN=$(find ../clang_dir -name "clang-r*" -type d | head -n 1)/bin
          export PATH=$CLANG_BIN:$GITHUB_WORKSPACE/gcc64/bin:$GITHUB_WORKSPACE/gcc32/bin:$PATH
          
          OUT_DIR=out
          CONF_FILE=$(find arch/arm64/configs/ -name "marble_defconfig" | sed 's|arch/arm64/configs/||')

          make -j$(nproc) O=$OUT_DIR ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            $CONF_FILE
            
          make -j$(nproc) O=$OUT_DIR ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            LLVM=1 LLVM_IAS=1 \
            LD=ld.lld AR=llvm-ar NM=llvm-nm OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: 5. 打包产物
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AnyKernel3/anykernel.sh
          sed -i 's/block=auto/block=\/dev\/block\/by-name\/boot/g' AnyKernel3/anykernel.sh
          
          find kernel/out/arch/arm64/boot/ -name "Image.gz*" -exec cp {} AnyKernel3/Image.gz \;
          find kernel/out/arch/arm64/boot/ -name "dtbo.img" -exec cp {} AnyKernel3/ \;
          
          cd AnyKernel3
          zip -r ../marble-a16-kernel.zip ./*

      - name: 6. 上传
        uses: actions/upload-artifact@v4
        with:
          name: Marble-Final-Kernel
          path: marble-a16-kernel.zip
