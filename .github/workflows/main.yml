name: Build Pixel 6 Mainline Kernel
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
steps:
      - name: 腾出磁盘空间
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: 安装并配置 Repo 工具
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          # 将 ~/bin 添加到全局 PATH，使其在后续所有 Step 中生效
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: 同步内核源码 (6.12 分支)
        # 注意：这里不再需要手动 export PATH 了
        run: |
          repo init -u https://android.googlesource.com/kernel/manifest -b gs-android16-6.12-gs101 --depth=1
          repo sync -c -j8 --no-tags --no-clone-bundle

      - name: 确认项目结构
        run: |
          ls -F
          # 检查 private 目录是否存在
          if [ -d "private/devices/google/raviole" ]; then
            echo "✅ 找到专用驱动目录"
          else
            echo "❌ 未找到驱动目录，检查同步结果"
            find . -maxdepth 3 -name "raviole"
          fi

      - name: 使用 Kleaf 编译内核
        run: |
          # 增加 --allow_analysis_failures 以防依赖检查微报错
          ./tools/bazel run //private/devices/google/raviole:slider_dist -- --dist_dir=out/dist
          
      - name: 上传镜像
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-6.12-Kernel
          path: out/slider/dist/*.img
