name: Build Pixel 6 Mainline Kernel
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 腾出磁盘空间 (最重要，否则 100% 报错)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: 同步内核源码
        run: |
          export PATH=$PATH:~/bin
          repo init -u https://android.googlesource.com/kernel/manifest -b gs-android16-6.12-gs101
          repo sync -c -j8
          
      - name: 确认 BUILD 文件位置
        run: |
          # 这里的搜索能帮你确定正确的 Bazel 路径
          find . -name "slider_dist" || echo "未找到 slider 目标"

      - name: 使用 Kleaf 编译内核
        run: |
          # 尝试新的路径格式
          ./tools/bazel run //private/devices/google/raviole:slider_dist -- --dist_dir=out/dist
          
      - name: 上传镜像
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-6.12-Kernel
          path: out/slider/dist/*.img
