name: Build Pixel 6 Mainline Kernel
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 腾出磁盘空间 (最重要，否则 100% 报错)
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"

      - name: 安装 Repo 工具
        run: |
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=$PATH:~/bin

      - name: 同步内核源码 (6.12 分支)
        run: |
          export PATH=$PATH:~/bin
          repo init -u https://android.googlesource.com/kernel/manifest -b gs-android16-6.12-gs101 --depth=1
          repo sync -c -j8 --no-tags --no-clone-bundle

      - name: 使用 Kleaf 编译内核
        run: |
          # 编译 Pixel 6 的目标产物 (代号 slider)
          ./tools/bazel run //private/devices/google/raviole:slider_dist

      - name: 上传镜像
        uses: actions/upload-artifact@v4
        with:
          name: Pixel6-6.12-Kernel
          path: out/slider/dist/*.img
