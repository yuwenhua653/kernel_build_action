name: Build Pixel 10 Pro XL Ultra-SUSFS (Linux 6.6)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 磁盘深度扩容
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true

      - name: 2. 按照 tbalden 结构拼装源码 (A16 / 6.6)
        run: |
          mkdir kernel_workspace && cd kernel_workspace
          
          # 1. 克隆核心内核树 (common)
          git clone -b aosp_cleanslate_a16_6_6_unified --depth=1 https://github.com/tbalden/google_common_aosp_simple common
          
          # 2. 克隆驱动树 (drivers)
          git clone -b cleanslate_unified_a16_6_6 --depth=1 https://github.com/tbalden/google_common_kernel_drivers_simple drivers
          
          # 3. 创建 private 目录并建立链接 (关键修复)
          mkdir -p private
          # 将 drivers 目录链接为 private/google-modules
          ln -s ../drivers private/google-modules
          
          # 4. 克隆构建辅助脚本
          git clone --depth=1 https://github.com/tbalden/google_common_kernel_builder_cs build_scripts

      - name: 3. 集成 SUSFS & Sukisu Ultra
        run: |
          cd kernel_workspace/common
          
          # 1. 下载 SUSFS 源码与补丁 (改用 GitHub 上的同步镜像或直接拉取特定分支)
          # 使用 Simonpunk 维护的 GitHub 镜像（如存在）或通用补丁源
          git clone https://github.com/simonpunk/susfs4linux.git || \
          git clone https://github.com/TheRealBeYond/susfs4linux.git
          
          # 2. 应用内核补丁 (针对 Linux 6.6 核心文件)
          # 检查目录是否存在并拷贝
          if [ -d "susfs4linux/kernel_patches/6.6" ]; then
            cp susfs4linux/kernel_patches/6.6/fs/* fs/
            cp susfs4linux/kernel_patches/6.6/include/linux/susfs.h include/linux/
          else
            # 兼容性回退：如果 6.6 目录未找到，尝试 6.1 或最新的通配补丁
            cp susfs4linux/kernel_patches/fs/* fs/ || true
            cp susfs4linux/kernel_patches/include/linux/susfs.h include/linux/ || true
          fi
          
          # 3. 集成 Sukisu Ultra (KernelSU Next)
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          
          # 4. 启用集成参数
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_SUSFS=y"
            echo "CONFIG_KPM=y"
            echo "CONFIG_OVERLAY_FS=y"
            echo "CONFIG_KPROBES=y"
            echo "CONFIG_ARM64_16K_PAGES=y"
            echo "CONFIG_PAGE_SIZE_16KB=y"
          } >> arch/arm64/configs/gki_defconfig
          # 4. 启用集成参数
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_SUSFS=y"
            echo "CONFIG_SUSFS=y"
            echo "CONFIG_KPM=y"
            echo "CONFIG_OVERLAY_FS=y"
            echo "CONFIG_KPROBES=y"
            # 针对 Pixel 10 Pro XL 的 16KB 页大小支持
            echo "CONFIG_ARM64_16K_PAGES=y"
            echo "CONFIG_PAGE_SIZE_16KB=y"
          } >> arch/arm64/configs/gki_defconfig

      - name: 4. 编译内核 (Kleaf 模式)
        run: |
          cd kernel_workspace
          ./common/tools/bazel build --config=fast \
            --jobs=2 \
            //private/devices/google/franklin:franklin_dist

      - name: 5. 提取并二次确认产物
        run: |
          mkdir output
          find kernel_workspace/bazel-bin/ -name "boot.img" -exec cp {} output/ \;
          # 包含 DTB 以确保屏幕驱动正常
          find kernel_workspace/bazel-bin/ -name "dtb.img" -exec cp {} output/ \;
          tar -czvf Pixel10PXL-Full-Mod.tar.gz -C output .

      - name: 6. 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pixel10PXL-Advanced-Kernel
          path: Pixel10PXL-Full-Mod.tar.gz
